{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id":    "https://example.com/lean-research-schema.json",
  "title":  "Lean Research-Engine Output",
  "schemaVersion": "0.3.0",
  "type": "object",
  "additionalProperties": true,
  "properties": {
    "universe":  { "$ref": "#/$defs/module" },
    "alphas":    { "$ref": "#/$defs/module" },
    "risk":      { "$ref": "#/$defs/module" },
    "portfolio": { "$ref": "#/$defs/module" },
    "execution": { "$ref": "#/$defs/module" },
    "misc": { "type": "object", "description": "Free-form dump (refine later)" },
    "inspiration": {
      "type": "string",
      "description": "Free-form text field"
    },
    "instruments": {
      "type": "array",
      "items": {
        "type": "string",
        "enum": ["stocks", "options", "futures", "forex", "crypto"]
      },
      "minItems": 1,
      "uniqueItems": true,
      "description": "Financial instruments that the trading algorithm is designed to trade. Must specify at least one instrument type."
    },
    "alpha-only": {
      "type": "boolean",
      "default": false,
      "description": "If true, only 'alphas' and 'universe' properties are permitted (plus this flag)."
    }
  },
  "required": ["instruments"],
  "if": {
    "properties": { "alpha-only": { "const": true } },
    "required": ["alpha-only"]
  },
  "then": {
    "propertyNames": { "enum": ["alphas", "universe", "instruments", "alpha-only"] },
    "required": ["alphas", "universe", "instruments"],
    // In alpha-only mode:
    // - alphas: exactly one item, and it must be in 'new'
    // - universe: exactly one item, and it must be in 'new'
    "properties": {
      "alphas": {
        "type": "object",
        "required": ["new"],
        "properties": {
          "new": { "type": "array", "minItems": 1, "maxItems": 1 }
        }
      },
      "universe": {
        "type": "object",
        "required": ["new"],
        "properties": {
          "new": { "type": "array", "minItems": 1, "maxItems": 1 }
        }
      }
    }
  },
  "else": {
    "required": ["inspiration"],
    "properties": {
      "alphas": {
        "type": "object",
        "properties": {
          "new": { "type": "array" }
        }
      }
    }
  },
  "$defs": {
    "module": {
      "type": "object",
      "additionalProperties": true,
      "properties": {
        "new": { "$ref": "#/$defs/componentNewArray" }
      }
    },

    "componentNewArray": { "type": "array", "items": { "$ref": "#/$defs/componentNew" } },

    "componentNew": {
      "type": "object",
      "required": ["name"],
      "additionalProperties": true,
      "properties": {
        "name":        { "type": "string" },
        "componentId": { "type": "string" },
        "version":     { "type": "string" },
        "title":       { "type": "string" },
        "description": { "type": "string" },
        "text":        { "type": "string" },
        "params":      { "$ref": "#/$defs/paramArray" },
        "location":    false
      }
    },

    "paramArray": { "type": "array", "items": { "$ref": "#/$defs/param" } },

    "param": {
      "type": "object",
      "required": ["name", "type"],
      "additionalProperties": true,
      "properties": {
        "name": { "type": "string" },
        "type": {
          "type": "string",
          "enum": ["string","int","float","bool","enum",
                  "datetime","symbol"]
        },

        "value":      {},
        "enumValues": { "type":"array","items":{"type":"string"} },

        "minimum": {
          "type": ["integer","number","string"],
          "description": "Optuna lower bound for the parameter."
        },
        "maximum": {
          "type": ["integer","number","string"],
          "description": "Optuna upper bound for the parameter."
        },

        "tuning": {
          "type": "object",
          "properties": {
            "distribution": {
              "type": "string",
              "enum": ["uniform", "step", "categorical", "log"],
              "description": "Distribution type for Optuna parameter sampling"
            },
            "step": {
              "type": "number",
              "description": "Step size when using step distribution"
            }
          },
          "additionalProperties": true
        }
      },

      "examples": [
        { "name":"riskThreshold","type":"float","minimum":0,"maximum":1,
          "tuning":{"distribution":"uniform"} },
        { "name":"rebalanceDay","type":"enum",
          "enumValues":["Mon","Wed","Fri"],
          "tuning":{"distribution":"categorical"} }
      ]
    }
  }
}
